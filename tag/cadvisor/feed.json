{
    "version": "https://jsonfeed.org/version/1",
    "title": "上善若水 • All posts by \"cadvisor\" tag",
    "description": "若能避开猛烈的欢喜，自然也不会有悲痛的来袭.",
    "home_page_url": "http://yunyat.cloud",
    "items": [
        {
            "id": "http://yunyat.cloud/linux/docker/%E4%BD%BF%E7%94%A8cAdvisor-Prometheus-Grafana%E7%9B%91%E6%8E%A7Docker%E5%AE%B9%E5%99%A8/",
            "url": "http://yunyat.cloud/linux/docker/%E4%BD%BF%E7%94%A8cAdvisor-Prometheus-Grafana%E7%9B%91%E6%8E%A7Docker%E5%AE%B9%E5%99%A8/",
            "title": "使用cAdvisor+Prometheus+Grafana监控Docker容器",
            "date_published": "2023-09-26T15:22:58.000Z",
            "content_html": "<h4 id=\"10-下载镜像\"><a class=\"markdownIt-Anchor\" href=\"#10-下载镜像\">#</a> 1.0 下载镜像</h4>\n<ol>\n<li>先使用下面的命令下载必要的镜像</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> pull google/cadvisor <span class=\"token punctuation\">;</span> <span class=\"token function\">docker</span> pull prom/prometheus <span class=\"token punctuation\">;</span> <span class=\"token function\">docker</span> pull grafana/grafana</pre></td></tr></table></figure><p><img data-src=\"https://z1.ax1x.com/2023/09/26/pPHGeun.png\" alt=\"pPHGeun.png\"></p>\n<h4 id=\"20-cadvisor-的部署\"><a class=\"markdownIt-Anchor\" href=\"#20-cadvisor-的部署\">#</a> 2.0 cAdvisor 的部署</h4>\n<ol>\n<li>使用下面的命令将本地的 根目录、/sys、/var/lib/docker、/dev/disk 等目录以只读形式挂载到容器里，然后使用 -p 将本地端口映射到容器，使用 --privileged 给予容器特权模式，使用 --device=/dev/kmsg 将主机的 /dev/kmsg 设备文件添加到容器中</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">-v</span> /:/rootfs:ro <span class=\"token parameter variable\">-v</span> /var/run:/var/run:ro <span class=\"token parameter variable\">-v</span> /sys:/sys:ro <span class=\"token parameter variable\">-v</span> /var/lib/docker/:/var/lib/docker:ro <span class=\"token parameter variable\">-v</span> /dev/disk/:/dev/disk:ro <span class=\"token parameter variable\">-p</span> <span class=\"token number\">25571</span>:8080 <span class=\"token parameter variable\">--detach</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>cadvisor <span class=\"token parameter variable\">--privileged</span> <span class=\"token parameter variable\">--device</span><span class=\"token operator\">=</span>/dev/kmsg google/cadvisor</pre></td></tr></table></figure><p><img data-src=\"https://z1.ax1x.com/2023/09/26/pPHwpYq.png\" alt=\"pPHwpYq.png\"></p>\n<ol start=\"2\">\n<li>在浏览器输入  <code>你的ip:25571/containers/docker</code>  即可访问</li>\n</ol>\n<p><img data-src=\"https://z1.ax1x.com/2023/09/26/pPHwilT.png\" alt=\"pPHwilT.png\"></p>\n<h4 id=\"30-prometheus-的部署\"><a class=\"markdownIt-Anchor\" href=\"#30-prometheus-的部署\">#</a> 3.0 Prometheus 的部署</h4>\n<ol>\n<li>先创建配置文件存放的目录，然后使用 vim 创建并编辑  <code>prometheus.yml</code>  配置文件</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/prometheus <span class=\"token punctuation\">;</span> <span class=\"token function\">vim</span> /etc/prometheus/prometheus.yml</pre></td></tr></table></figure><ol start=\"2\">\n<li>然后在 prometheus.yml 文件中写入以下内容</li>\n</ol>\n<p>将 ip 地址跟端口号改为自己的就行</p>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>global:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   scrape_interval: 15s</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   evaluation_interval: 15s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre> alerting:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  alertmanagers:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  - static_configs:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    - targets:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> rule_files:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> scrape_configs:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   - job_name: <span class=\"token string\">'prometheus'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     static_configs:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     - targets: <span class=\"token punctuation\">[</span><span class=\"token string\">'192.168.234.128:25572'</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   - job_name: <span class=\"token string\">'cadvisor'</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     static_configs:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     - targets: <span class=\"token punctuation\">[</span><span class=\"token string\">'192.168.234.128:25571'</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><blockquote>\n<p>注意：缩进一定要跟我的一样，错一个字符都不行，因为我容器已经运行起来了才截的图，所以你们现在应该是没有这个容器的</p>\n</blockquote>\n<p><img data-src=\"https://z1.ax1x.com/2023/09/26/pPHw9f0.png\" alt=\"pPHw9f0.png\"></p>\n<ol start=\"3\">\n<li>使用 run 将容器运行起来</li>\n</ol>\n<blockquote>\n<p>建议先使用 docker ps -a 查看容器有没有真正运行起来，有时候会出现成功创建但是没有运行起来的情况，这种情况一般都是配置文件有问题导致的</p>\n</blockquote>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-itd</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>prometheus <span class=\"token parameter variable\">-p</span> <span class=\"token number\">25572</span>:9090 <span class=\"token parameter variable\">-v</span> /etc/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus <span class=\"token parameter variable\">--config.file</span><span class=\"token operator\">=</span>/etc/prometheus/prometheus.yml --web.enable-lifecycle</pre></td></tr></table></figure><ol start=\"4\">\n<li>在浏览器输入你的 ip:25572/targets 来访问</li>\n</ol>\n<p><img data-src=\"https://z1.ax1x.com/2023/09/26/pPHwPpV.png\" alt=\"pPHwPpV.png\"></p>\n<h4 id=\"40-grafana-的部署\"><a class=\"markdownIt-Anchor\" href=\"#40-grafana-的部署\">#</a> 4.0 Grafana 的部署</h4>\n<ol>\n<li>因为之前已经把所有的镜像都已经下载了，所以直接用 run 来运行就行了，之后在浏览器中使用 你的 IP:25573/login 来访问即可</li>\n</ol>\n<figure class=\"highlight shell\"><figcaption data-lang=\"Bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-itd</span> <span class=\"token parameter variable\">--name</span><span class=\"token operator\">=</span>grafana <span class=\"token parameter variable\">-p</span> <span class=\"token number\">25573</span>:3000 grafana/grafana</pre></td></tr></table></figure><p><img data-src=\"https://z1.ax1x.com/2023/09/27/pPHyPpR.png\" alt=\"pPHyPpR.png\"></p>\n<ol start=\"2\">\n<li>默认账号及密码都为 admin ，登录之后网站会强制你更新密码</li>\n</ol>\n<p><img data-src=\"https://z1.ax1x.com/2023/09/27/pPHyZ7D.png\" alt=\"pPHyZ7D.png\"></p>\n<ol start=\"3\">\n<li>进入管理界面之后点击 DATA SOURCES 来创建数据源</li>\n</ol>\n<p><img data-src=\"https://z1.ax1x.com/2023/09/27/pPHyV0O.png\" alt=\"pPHyV0O.png\"></p>\n<ol start=\"4\">\n<li>选择第一个数据源</li>\n</ol>\n<p><img data-src=\"https://z1.ax1x.com/2023/09/27/pPHyuhd.png\" alt=\"pPHyuhd.png\"></p>\n<ol start=\"5\">\n<li>在 HTTP 的 URL 栏填入你的 Prometheus 访问地址，然后选 Save &amp; test 保存并退出</li>\n</ol>\n<p>如：</p>\n<figure class=\"highlight http\"><figcaption data-lang=\"HTTP\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token header\"><span class=\"token header-name keyword\">http</span><span class=\"token punctuation\">:</span><span class=\"token header-value\">//192.168.234.128:25572/targets</span></span></pre></td></tr></table></figure><p><img data-src=\"https://z1.ax1x.com/2023/09/27/pPHy8nf.png\" alt=\"pPHy8nf.png\"></p>\n<ol start=\"6\">\n<li>点击左边工具栏的 ‘+’ 号，然后点击 Import ，输入 193 ，点击后面的 Import</li>\n</ol>\n<p><img data-src=\"https://z1.ax1x.com/2023/09/27/pPHytAg.png\" alt=\"pPHytAg.png\"></p>\n<ol start=\"7\">\n<li>在 Prometheus 列选择数据源，之后点击 Import</li>\n</ol>\n<p><img data-src=\"https://z1.ax1x.com/2023/09/27/pPHy0cq.png\" alt=\"pPHy0cq.png\"></p>\n<ol start=\"8\">\n<li>之后就可以看到仪表盘显示的数据了</li>\n</ol>\n<p><img data-src=\"https://z1.ax1x.com/2023/09/27/pPHycEF.png\" alt=\"pPHycEF.png\"></p>\n<hr>\n<p>END</p>\n",
            "tags": [
                "Docker",
                "cAdvisor",
                "Prometheus",
                "Grafana"
            ]
        }
    ]
}